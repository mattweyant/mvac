import googlemaps
import csv
import pyproj
from shapely.geometry import Polygon, Point
from shapely.ops import transform
from functools import partial

API_KEY = 'AIzaSyAZDkiggOnItBtG3V7qAaDClT2oYI72UZc'

gmaps = googlemaps.Client(key=API_KEY)

project = partial(
    pyproj.transform,
    pyproj.Proj(init='epsg:4326'),
    pyproj.Proj('+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs'))


# Based on Google Map: https://www.google.com/maps/d/viewer?mid=1iTNykWvrM6rLX7oxEfRtdzDDpwo&hl=en&ll=42.423266228194485%2C-71.11093999999997&z=13
NEIGHBORHOODS = [
    {
        'name': 'Hillside',
        'geometry': transform(project, Polygon(([-71.12694,42.41715], [-71.12802,42.41562999999999], [-71.12445,42.40828], [-71.11527000000001,42.4047], [-71.11669,42.40710000000001], [-71.11342,42.41067999999999], [-71.11321,42.41181999999999], [-71.11068,42.41205], [-71.11061,42.41702000000001], [-71.11265,42.41797], [-71.1133,42.41788], [-71.12081000000002,42.4181], [-71.12205,42.4188], [-71.12561,42.418], [-71.12713,42.418336], [-71.128165,42.41801900000001], [-71.12694,42.41715])))
    },
    {
        'name': 'West Medford',
        'geometry': transform(project, Polygon(([-71.14531,42.42256], [-71.14274,42.42193], [-71.14316,42.419900000000005], [-71.14007,42.41642], [-71.13716,42.41534], [-71.13424000000002,42.41552999999999], [-71.13218,42.41521], [-71.13192,42.41693], [-71.12711,42.41832], [-71.12557,42.41799999999999], [-71.12205,42.4188], [-71.120816,42.418103], [-71.117962,42.418011], [-71.11802,42.42123000000001], [-71.12214,42.42751], [-71.12746,42.43397], [-71.14977,42.43315], [-71.14531,42.42256])))
    },
    {
        'name': 'Fulton Heights',
        'geometry': transform(project, Polygon(([-71.094493,42.44207300000001], [-71.096649,42.440965], [-71.096982,42.440474], [-71.097057,42.439928], [-71.09767,42.43897], [-71.099503,42.43969], [-71.1027,42.438089999999995], [-71.101917,42.43509000000001], [-71.101305,42.433728], [-71.101853,42.432065], [-71.10269,42.431716], [-71.103151,42.429847], [-71.103258,42.425999], [-71.10135900000002,42.425769], [-71.099364,42.42546], [-71.09652,42.42531000000001], [-71.093709,42.424652], [-71.090899,42.42443900000001], [-71.089858,42.424051000000006], [-71.088592,42.424906], [-71.086714,42.42537299999999], [-71.084697,42.439357], [-71.088367,42.44125], [-71.091542,42.440529], [-71.09398,42.44257999999999], [-71.094493,42.44207300000001])))
    },
    {
        'name': 'Medford Square',
        'geometry': transform(project, Polygon(([-71.117967,42.41801900000001], [-71.1133,42.417897], [-71.112689,42.417984], [-71.11066,42.41707], [-71.11016000000001,42.417669999999994], [-71.10883,42.41712], [-71.10611,42.41512000000001], [-71.104074,42.414839], [-71.104202,42.418831], [-71.10328,42.426015], [-71.103162,42.429151], [-71.10452400000001,42.428691], [-71.104535,42.427986], [-71.108075,42.421112], [-71.108816,42.42131], [-71.11003,42.41908], [-71.11441,42.41993999999999], [-71.11802,42.42139], [-71.117967,42.41801900000001])))
    },
    {
        'name': 'Lawrence Estates',
        'geometry': transform(project, Polygon(([-71.1181,42.42142], [-71.1145,42.41997], [-71.11006,42.419085], [-71.108816,42.421318], [-71.108075,42.421128], [-71.104513,42.427979], [-71.104481,42.42869100000001], [-71.103172,42.42912700000001], [-71.103162,42.429840000000006], [-71.11218,42.43232], [-71.11377,42.4314], [-71.11308,42.42548], [-71.11501000000001,42.42573], [-71.11664,42.429030000000004], [-71.12218,42.42754], [-71.1181,42.42142])))
    },
    {
        'name': 'East Strip',
        'geometry': transform(project, Polygon(([-71.100597,42.409611], [-71.098967,42.407456], [-71.094332,42.404478], [-71.094117,42.402608], [-71.09077,42.400104999999996], [-71.08665,42.400802], [-71.076393,42.397126], [-71.075664,42.399851], [-71.073217,42.403939], [-71.074591,42.40428800000001], [-71.081586,42.404858], [-71.08459000000002,42.409706], [-71.087165,42.410815], [-71.085706,42.4156], [-71.087937,42.415219], [-71.08926800000002,42.413857], [-71.091413,42.41391999999999], [-71.092486,42.409168], [-71.097851,42.411069], [-71.09806500000002,42.412716], [-71.100683,42.41233600000001], [-71.100597,42.409611])))
    },
    {
        'name': 'West Strip',
        'geometry': transform(project, Polygon(([-71.110618,42.414617], [-71.1075,42.41091], [-71.10682,42.4111], [-71.10484,42.40903999999999], [-71.10222,42.40355000000001], [-71.09828,42.4001], [-71.09733000000001,42.401529999999994], [-71.09364,42.39943], [-71.09072,42.40007000000001], [-71.09407,42.40260000000001], [-71.09424,42.40438000000001], [-71.09905,42.40755], [-71.10059,42.4097], [-71.10068,42.41239000000001], [-71.10295,42.41467999999999], [-71.106005,42.415093], [-71.10873,42.417041], [-71.110232,42.41770600000001], [-71.11064,42.41705700000001], [-71.110618,42.414617])))
    },
    {
        'name': 'South Medford',
        'geometry': transform(project, Polygon(([-71.110811,42.412114], [-71.113257,42.411797], [-71.113472,42.41072], [-71.116776,42.40726600000001], [-71.115489,42.40476300000001], [-71.115575,42.402735], [-71.114244,42.400929], [-71.101155,42.396460000000005], [-71.098323,42.400105], [-71.102185,42.40349499999999], [-71.104889,42.409009], [-71.106734,42.411164], [-71.107464,42.41091], [-71.11064,42.414491], [-71.110811,42.412114])))
    },
    {
        'name': 'Wellington',
        'geometry': transform(project, Polygon(([-71.08562,42.41556800000001], [-71.087251,42.410815], [-71.08459000000002,42.409738], [-71.081586,42.404858], [-71.074591,42.404319], [-71.073303,42.403907], [-71.072187,42.405618999999994], [-71.073346,42.412685], [-71.076608,42.41297], [-71.08562,42.41556800000001])))
    },
    {
        'name': 'Glenwood',
        'geometry': transform(project, Polygon(([-71.104202,42.418831], [-71.104074,42.414839], [-71.103086,42.414776], [-71.10218000000002,42.413880000000006], [-71.10064,42.41239000000001], [-71.09806,42.41274000000001], [-71.09798,42.41116], [-71.09248,42.40919], [-71.09128,42.41388], [-71.08926,42.41385], [-71.08798,42.41525000000001], [-71.0857,42.41563], [-71.08716,42.4218], [-71.08673,42.42535000000001], [-71.088592,42.424882], [-71.089826,42.424051], [-71.09092000000001,42.424446], [-71.093752,42.42466000000001], [-71.096488,42.425294], [-71.099396,42.425436], [-71.101305,42.425737000000005], [-71.10326900000001,42.425999], [-71.104202,42.418831])))
    },
    {
        'name': 'Fells',
        'geometry': transform(project, Polygon(([-71.122205,42.427511], [-71.11664,42.42896], [-71.115081,42.425769], [-71.113064,42.4255], [-71.11355,42.43143], [-71.11235,42.432379999999995], [-71.103151,42.42984], [-71.102679,42.431724], [-71.101874,42.432081], [-71.101338,42.433736], [-71.10196,42.435098], [-71.10265,42.43812], [-71.099492,42.439674], [-71.097679,42.438985], [-71.097314,42.439437], [-71.097068,42.439928], [-71.097035,42.440458], [-71.096671,42.440973], [-71.094471,42.44212099999999], [-71.09398,42.44257999999999], [-71.091596,42.440537], [-71.08832,42.44125], [-71.08471,42.43935], [-71.08394,42.44454999999999], [-71.11948,42.45006], [-71.12729,42.433840000000004], [-71.122205,42.427511])))
    }
]

m = []
with open('memorials.csv') as memorials:
    reader = csv.DictReader(memorials)
    for row in reader:
        name = row['Name']
        location = row['Location']
        neighborhood = row['Neighborhood']
        latitude = None
        longitude = None
        address = None
        viewport = None

        q = '%s, Medford, MA' % location
        result = gmaps.geocode(q)
        if not result:
            print '%s -> %s' % (q, result)
        if result:
            latitude = result[0][u'geometry'][u'location'][u'lat']
            longitude = result[0][u'geometry'][u'location'][u'lng']
            address = result[0][u'formatted_address']
            viewport = result[0][u'geometry'][u'viewport']

            if address:
                location = address.split(',')[0]
            address_components = result[0][u'address_components']

            for c in address_components:
                if u'neighborhood' in c[u'types']:
                    neighborhood = c[u'long_name']

            point = transform(project, Point(longitude, latitude))
            for n in NEIGHBORHOODS:
                if n['geometry'].contains(point):
                    neighborhood = n['name']

        if location == 'Medford':
            print '%s -> %s' % (q, result)
            location = row['Location']

        m.append({
            'name': name,
            'location': location,
            'neighborhood': neighborhood,
            'latitude': latitude,
            'longitude': longitude,
            'viewport': viewport
        })

with open('final-memorials.csv', 'w') as memorials:
    writer = csv.DictWriter(memorials, fieldnames=['name', 'location', 'neighborhood', 'latitude', 'longitude'], extrasaction='ignore')
    writer.writeheader()
    writer.writerows(m)